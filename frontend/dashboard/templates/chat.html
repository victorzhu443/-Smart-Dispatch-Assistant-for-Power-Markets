{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Dispatch Chat</h2>

  <div id="chatbox" class="chatbox"></div>

  <div class="row">
    <input id="question" class="input" placeholder='Ask: "Should we dispatch the gas peaker?"'/>
    <button id="send">Send</button>
  </div>

  <div id="meta" class="pill" style="display:none;"></div>
</section>

<script>
const $ = (q)=>document.querySelector(q);

function addMsg(role, text){
  const div = document.createElement("div");
  div.className = `bubble ${role}`;
  div.textContent = text;
  $("#chatbox").appendChild(div);
  $("#chatbox").scrollTop = $("#chatbox").scrollHeight;
  return div;
}

async function ask(question){
  const user = addMsg("user", question);
  const typing = addMsg("bot", "…");
  const t0 = performance.now();
  try{
    const res = await fetch("/api/query", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({question})
    });
    const t1 = performance.now();
    const ms = Math.round(t1 - t0);
    const data = await res.json();

    typing.remove();
    addMsg("bot", data.answer || "No answer");

    // show latency + retrieved doc ids (top-3)
    const docs = (data.context_used || []).slice(0,3).map(d=>d.doc_id).join(" • ");
    const meta = `Latency: ${ms} ms  ${docs ? " • Context: " + docs : ""}`;
    const pill = $("#meta");
    pill.textContent = meta;
    pill.style.display = "inline-block";
  }catch(e){
    typing.remove();
    addMsg("bot", "Error contacting /api/query");
    console.error(e);
  }
}

$("#send").addEventListener("click", ()=>{
  const q = $("#question").value.trim();
  if (!q) return;
  $("#question").value = "";
  ask(q);
});

$("#question").addEventListener("keydown", (e)=>{
  if (e.key === "Enter") $("#send").click();
});
</script>
{% endblock %}
